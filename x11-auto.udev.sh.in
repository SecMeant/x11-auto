#!/bin/bash
#
# udev-trigger.sh
# Wrapper script called by udev rule to handle display changes
# This script finds the correct user context and triggers the main positioning script
#
# Generated by: Claude-Sonnet 4.5
# Date: November 4, 2025
#
# Arguments from udev:
#   $1 - kernel device name (e.g., card0-HDMI-A-1)
#   $2 - device name (e.g., /dev/dri/card0)
#   $3 - device path in sysfs

KERNEL_NAME="$1"
DEV_NAME="$2"
DEV_PATH="$3"

LOG_FILE="/var/log/x11-auto.log"

# Create log files with proper permissions (running as root via udev)
touch "$LOG_FILE" 2>/dev/null || true
chmod 666 "$LOG_FILE" 2>/dev/null || true

echo "[$(date)] Display event detected:" >> "$LOG_FILE"
echo "  Kernel device: $KERNEL_NAME" >> "$LOG_FILE"
echo "  Device name: $DEV_NAME" >> "$LOG_FILE"
echo "  Device path: $DEV_PATH" >> "$LOG_FILE"

# Find the user running X11 session
X_USER=$(who | grep -E "tty[0-9]+ .+\(:0\)" | awk '{print $1}' | head -1)

# Alternative: check for users with DISPLAY :0
if [[ -z "$X_USER" ]]; then
    X_USER=$(ps aux | grep "X.*:0" | grep -v grep | awk '{print $1}' | head -1)
fi

if [[ -z "$X_USER" ]]; then
    echo "[$(date)] ERROR: Could not determine X11 user" >> "$LOG_FILE"
    exit 1
fi

# Get user's HOME directory
X_USER_HOME=$(getent passwd "$X_USER" | cut -d: -f6)

# Set up environment and run the main script as the X11 user
# Pass the device information as environment variables
sudo -u "$X_USER" \
    DISPLAY=:0 \
    XAUTHORITY="$X_USER_HOME/.Xauthority" \
    HOME="$X_USER_HOME" \
    XDG_STATE_HOME="$X_USER_HOME/.local/state" \
    HOTPLUG_KERNEL_NAME="$KERNEL_NAME" \
    HOTPLUG_DEV_NAME="$DEV_NAME" \
    HOTPLUG_DEV_PATH="$DEV_PATH" \
    @SCRIPT_DIR@/x11-auto.sh >> "$LOG_FILE" 2>&1 &


